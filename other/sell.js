// –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è Trader
let traderInitialized = false;
let isEditMode = false;
let traderData = null;
let itemImages = {};
let pageBackground = null; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–æ–Ω–æ–≤–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
let currentLang = 'en';
let isTraderVisible = false;

// –ö–µ—à—É–≤–∞–Ω–Ω—è DOM –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
const traderCache = {
    page: null,
    lastRender: 0,
    renderDelay: 100 // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —á–∞—Å –º—ñ–∂ —Ä–µ–Ω–¥–µ—Ä–∞–º–∏
};

async function loadTraderJSON() {
    if (traderData) return traderData; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–µ—à
    
    try {
        const response = await fetch('other/sell.json');
        traderData = await response.json();
        return traderData;
    } catch (error) {
        console.error('Error loading trader data:', error);
        return null;
    }
}

async function initializeTrader() {
    if (traderInitialized) {
        console.log('‚ö†Ô∏è Trader already initialized, re-rendering...');
        currentLang = getCurrentAppLanguage?.() || 'en';
        renderTraderStore(currentLang);
        return;
    }

    traderCache.page = document.getElementById('traderPage');
    if (!traderCache.page) {
        console.error('‚ùå Trader page not found');
        return;
    }

    console.log('üöÄ Initializing Trader...');
    await loadTraderJSON();
    
    currentLang = getCurrentAppLanguage?.() || 'en';
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤–∏–¥–∏–º–∞ –∑–∞—Ä–∞–∑
    const isVisible = traderCache.page.offsetParent !== null;
    console.log('üëÅÔ∏è Trader page visible:', isVisible);
    
    if (isVisible) {
        // –Ø–∫—â–æ –≤–∏–¥–∏–º–∞ - —Ä–µ–Ω–¥–µ—Ä–∏–º–æ –æ–¥—Ä–∞–∑—É
        renderTraderStore(currentLang);
        isTraderVisible = true;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤–∏–¥–∏–º–∞
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            isTraderVisible = entry.isIntersecting;
            console.log('üîÑ Trader visibility changed:', isTraderVisible);
            
            if (isTraderVisible && !traderCache.page.innerHTML) {
                renderTraderStore(currentLang);
            }
        });
    });
    
    observer.observe(traderCache.page);
    
    traderInitialized = true;
    console.log('‚úÖ Trader initialized (optimized)');
}

function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (!file || file.size > 10000000) { // –õ—ñ–º—ñ—Ç 10MB
        if (file?.size > 10000000) {
            alert('Image too large! Max 10MB');
        }
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        pageBackground = e.target.result;
        applyPageBackground();
        console.log('üñºÔ∏è Page background uploaded');
    };
    reader.readAsDataURL(file);
}

function applyPageBackground() {
    if (!traderCache.page) return;
    
    if (pageBackground) {
        const style = traderCache.page.querySelector('style') || document.createElement('style');
        style.textContent = `
            #traderPage::before {
                background-image: url('${pageBackground}'), 
                    radial-gradient(circle at 20% 50%, rgba(255,100,0,0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 50%, rgba(138,43,226,0.08) 0%, transparent 50%) !important;
                background-blend-mode: overlay, normal, normal;
            }
        `;
        if (!traderCache.page.querySelector('style')) {
            traderCache.page.appendChild(style);
        }
        traderCache.page.classList.add('has-custom-bg');
    } else {
        const style = traderCache.page.querySelector('style');
        if (style) style.remove();
        traderCache.page.classList.remove('has-custom-bg');
    }
}

function removePageBackground() {
    pageBackground = null;
    applyPageBackground();
    console.log('üóëÔ∏è Page background removed');
}

function handleImageUpload(event, index, lang) {
    const file = event.target.files[0];
    if (!file || file.size > 5000000) { // –õ—ñ–º—ñ—Ç 5MB
        if (file?.size > 5000000) {
            alert('Image too large! Max 5MB');
        }
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        itemImages[`${lang}-${index}`] = e.target.result;
        
        // –û–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É, –∞ –Ω–µ –≤–µ—Å—å —Ä–µ–Ω–¥–µ—Ä
        const imgContainer = document.querySelector(`[data-img-id="${lang}-${index}"]`);
        if (imgContainer) {
            imgContainer.innerHTML = `<img src="${e.target.result}" alt="Item ${index}">`;
        }
    };
    reader.readAsDataURL(file);
}

function renderTraderStore(lang = 'en') {
    // Throttling - –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º–æ —á–∞—Å—Ç—ñ—à–µ –Ω—ñ–∂ —Ä–∞–∑ –Ω–∞ 100ms
    const now = Date.now();
    if (now - traderCache.lastRender < traderCache.renderDelay) {
        console.log('‚è±Ô∏è Throttling render...');
        return;
    }
    traderCache.lastRender = now;

    if (!traderCache.page) {
        console.error('‚ùå Trader page not found in cache');
        return;
    }
    
    if (!traderData?.[lang]) {
        console.error(`‚ùå No trader data for language: ${lang}`);
        return;
    }

    console.log(`üé® Rendering trader store for: ${lang}`);

    const data = traderData[lang];
    const items = data.items || [];
    
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ DocumentFragment –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
    const fragment = document.createDocumentFragment();
    const container = document.createElement('div');
    
    container.innerHTML = `
        ${!isEditMode ? `
            <button class="trader-settings-btn" onclick="toggleTraderEdit('${lang}')" title="${data.editButton}">‚öôÔ∏è</button>
        ` : `
            <label for="trader-bg-upload" class="trader-bg-btn" title="Upload Background">üñºÔ∏è</label>
            <input type="file" id="trader-bg-upload" class="trader-bg-input" accept="image/*" onchange="handleBackgroundUpload(event)">
        `}
        
        <div class="trader-header">
            ${isEditMode ? `
                <input type="text" class="edit-title" value="${data.title}" data-lang="${lang}" data-field="title">
                <input type="text" class="edit-subtitle" value="${data.subtitle}" data-lang="${lang}" data-field="subtitle">
            ` : `
                <h1 class="trader-title">${data.title}</h1>
                <div class="trader-subtitle">${data.subtitle}</div>
            `}
        </div>
        
        ${isEditMode ? `
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="saveTraderChanges('${lang}')" class="trader-btn trader-btn-save">${data.saveButton}</button>
                <button onclick="cancelTraderEdit('${lang}')" class="trader-btn trader-btn-cancel">${data.cancelButton}</button>
                ${pageBackground ? `<button onclick="removePageBackground()" class="trader-btn" style="background: linear-gradient(135deg, #666, #444); border-color: #666;">üóëÔ∏è Remove Background</button>` : ''}
            </div>
        ` : ''}
        
        <div class="trader-container">
            ${items.map((item, index) => createItemCard(item, index, lang, data, isEditMode)).join('')}
        </div>
    `;
    
    fragment.appendChild(container);
    
    // –û—á–∏—â–∞—î–º–æ —ñ –≤—Å—Ç–∞–≤–ª—è—î–º–æ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
    traderCache.page.innerHTML = '';
    traderCache.page.appendChild(fragment.firstChild);
    
    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ–æ–Ω –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä—É
    applyPageBackground();
    
    console.log('‚úÖ Trader store rendered');
}

// –í–∏–Ω–µ—Å–ª–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–æ–∫ –≤ –æ–∫—Ä–µ–º—É —Ñ—É–Ω–∫—Ü—ñ—é
function createItemCard(item, index, lang, data, editMode) {
    const imageKey = `${lang}-${index}`;
    const hasImage = itemImages[imageKey];
    
    return `
        <div class="trader-card">
            <div class="trader-image-container" data-img-id="${imageKey}">
                ${editMode ? `
                    <label class="trader-upload-area" for="file-${imageKey}">
                        ${hasImage ? `<img src="${itemImages[imageKey]}" alt="${item.name}">` : `
                            <div class="upload-icon">üì∏</div>
                            <div class="upload-text">Click</div>
                        `}
                    </label>
                    <input type="file" id="file-${imageKey}" class="trader-file-input" accept="image/*" onchange="handleImageUpload(event, ${index}, '${lang}')">
                ` : hasImage ? `
                    <img src="${itemImages[imageKey]}" alt="${item.name}">
                ` : `
                    <div class="trader-image-placeholder">${item.icon || 'üéÉ'}</div>
                `}
            </div>
            
            <div class="trader-card-body">
                ${editMode ? `
                    <input type="text" class="edit-name" value="${item.name || ''}" data-lang="${lang}" data-index="${index}" data-field="name">
                ` : `
                    <div class="trader-name">${item.name || ''}</div>
                `}
                
                <div class="trader-price">
                    <span class="price-label">${data.priceLabel}</span>
                    ${editMode ? `
                        <input type="text" class="edit-price" value="${item.price || ''}" data-lang="${lang}" data-index="${index}" data-field="price">
                    ` : `
                        <span class="price-value">${item.price || ''}</span>
                    `}
                </div>
                
                ${editMode ? `
                    <input type="text" class="edit-quantity" value="${item.quantity || ''}" data-lang="${lang}" data-index="${index}" data-field="quantity">
                ` : `
                    <div class="trader-quantity">${item.quantity || ''}</div>
                `}
            </div>
        </div>
    `;
}

function toggleTraderEdit(lang) {
    isEditMode = !isEditMode;
    renderTraderStore(lang);
}

function saveTraderChanges(lang) {
    const inputs = document.querySelectorAll('[data-lang]');
    
    // –ë–∞—Ç—á –∞–ø–¥–µ–π—Ç
    const updates = {};
    
    inputs.forEach(input => {
        const field = input.dataset.field;
        const index = input.dataset.index;
        const value = input.value.trim();
        
        if (index !== undefined) {
            const idx = parseInt(index);
            if (!updates[idx]) updates[idx] = {};
            updates[idx][field] = value;
        } else {
            if (!updates.global) updates.global = {};
            updates.global[field] = value;
        }
    });
    
    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–∏ —Ä–∞–∑–æ–º
    Object.keys(updates).forEach(key => {
        if (key === 'global') {
            Object.assign(traderData[lang], updates.global);
        } else {
            const idx = parseInt(key);
            if (!traderData[lang].items[idx]) {
                traderData[lang].items[idx] = {};
            }
            Object.assign(traderData[lang].items[idx], updates[key]);
        }
    });
    
    isEditMode = false;
    renderTraderStore(lang);
}

function cancelTraderEdit(lang) {
    isEditMode = false;
    renderTraderStore(lang);
}

function updateTraderLanguage(lang) {
    console.log('üåç Updating trader language to:', lang);
    currentLang = lang;
    
    // –ó–∞–≤–∂–¥–∏ —Ä–µ–Ω–¥–µ—Ä–∏–º–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –º–æ–≤–∏, —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
    const traderPage = document.getElementById('traderPage');
    const isActive = traderPage?.classList.contains('active');
    
    console.log('üìÑ Trader page active:', isActive);
    
    if (isActive || isTraderVisible) {
        renderTraderStore(lang);
    }
}

// –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ–π
window.initializeTrader = initializeTrader;
window.updateTraderLanguage = updateTraderLanguage;
window.toggleTraderEdit = toggleTraderEdit;
window.saveTraderChanges = saveTraderChanges;
window.cancelTraderEdit = cancelTraderEdit;
window.handleImageUpload = handleImageUpload;
window.handleBackgroundUpload = handleBackgroundUpload;
window.removePageBackground = removePageBackground;

// –°–ª—É—Ö–∞—á –∑–º—ñ–Ω–∏ –º–æ–≤–∏ –∑ debounce
let langChangeTimeout;
document.addEventListener('languageChanged', (e) => {
    clearTimeout(langChangeTimeout);
    langChangeTimeout = setTimeout(() => {
        console.log('üîî Language changed event received:', e.detail.language);
        updateTraderLanguage(e.detail.language);
    }, 150);
});

console.log('‚úÖ Trader module loaded (optimized)');
