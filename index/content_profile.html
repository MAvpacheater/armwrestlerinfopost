<!-- Profile Page -->
<div class="page profile-page" id="profilePage">
    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="https://i.postimg.cc/gjmcXwV9/file-000000008fd461f4826bd65e36dbc3d2.png/80x80/667eea/ffffff?text=üë§" alt="Avatar" class="avatar-img" id="profileAvatar">
            </div>
            <div class="profile-info">
                <h2 class="profile-nickname" id="profileNickname">Loading...</h2>
                <!-- Removed the "Member since" line -->
            </div>
        </div>

        <!-- Profile Actions -->
        <div class="profile-actions">
            <button class="action-btn settings-btn" onclick="toggleSettingsMenu()">
                <span class="btn-icon">‚öôÔ∏è</span>
                Settings
            </button>
            <button class="action-btn stats-btn" onclick="toggleStatsView()">
                <span class="btn-icon">üìä</span>
                Statistics
            </button>
            <button class="action-btn back-btn" onclick="goBackFromProfile()">
                <span class="btn-icon">‚Üê</span>
                Back
            </button>
        </div>

        <!-- Settings Menu (Hidden by default) -->
        <div class="settings-menu" id="settingsMenu" style="display: none;">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-btn" onclick="closeSettingsMenu()">√ó</button>
            </div>
            
            <div class="settings-options">
                <button class="settings-option-btn" onclick="showChangePassword()">
                    <span class="option-icon">üîí</span>
                    <div class="option-info">
                        <div class="option-title">Change Password</div>
                        <div class="option-desc">Update your account password</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </button>
                
                <button class="settings-option-btn" onclick="showChangeNickname()">
                    <span class="option-icon">‚úèÔ∏è</span>
                    <div class="option-info">
                        <div class="option-title">Change Nickname</div>
                        <div class="option-desc">Update your display name</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </button>
                
                <button class="settings-option-btn" onclick="showPreferences()">
                    <span class="option-icon">üéõÔ∏è</span>
                    <div class="option-info">
                        <div class="option-title">Preferences</div>
                        <div class="option-desc">App settings and preferences</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </button>
                
                <button class="settings-option-btn danger-option" onclick="confirmDeleteAccount()">
                    <span class="option-icon">‚ö†Ô∏è</span>
                    <div class="option-info">
                        <div class="option-title">Delete Account</div>
                        <div class="option-desc">Permanently delete your account</div>
                    </div>
                    <span class="option-arrow">‚Üí</span>
                </button>
            </div>
        </div>

        <!-- Change Password Form (Hidden by default) -->
        <div class="settings-form" id="changePasswordForm" style="display: none;">
            <div class="form-header">
                <button class="back-form-btn" onclick="backToSettingsMenu()">‚Üê</button>
                <h3>Change Password</h3>
                <button class="close-btn" onclick="closeSettingsMenu()">√ó</button>
            </div>
            
            <form onsubmit="handleChangePassword(event)">
                <div class="input-group">
                    <label for="currentPassword" class="input-label">Current Password</label>
                    <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password" required>
                </div>
                
                <div class="input-group">
                    <label for="newPassword" class="input-label">New Password</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="Enter new password (min 6 chars)" required minlength="6">
                </div>
                
                <div class="input-group">
                    <label for="confirmNewPassword" class="input-label">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm new password" required>
                </div>
                
                <button type="submit" class="submit-btn">Update Password</button>
            </form>
        </div>

        <!-- Change Nickname Form (Hidden by default) -->
        <div class="settings-form" id="changeNicknameForm" style="display: none;">
            <div class="form-header">
                <button class="back-form-btn" onclick="backToSettingsMenu()">‚Üê</button>
                <h3>Change Nickname</h3>
                <button class="close-btn" onclick="closeSettingsMenu()">√ó</button>
            </div>
            
            <form onsubmit="handleChangeNickname(event)">
                <div class="input-group">
                    <label for="currentNickname" class="input-label">Current Nickname</label>
                    <input type="text" id="currentNickname" class="form-input" readonly>
                </div>
                
                <div class="input-group">
                    <label for="newNickname" class="input-label">New Nickname</label>
                    <input type="text" id="newNickname" class="form-input" placeholder="Enter new nickname" required minlength="3" maxlength="20">
                </div>
                
                <button type="submit" class="submit-btn">Update Nickname</button>
            </form>
        </div>

        <!-- Preferences Form (Hidden by default) -->
        <div class="settings-form" id="preferencesForm" style="display: none;">
            <div class="form-header">
                <button class="back-form-btn" onclick="backToSettingsMenu()">‚Üê</button>
                <h3>Preferences</h3>
                <button class="close-btn" onclick="closeSettingsMenu()">√ó</button>
            </div>
            
            <div class="preferences-content">
                <div class="settings-row">
                    <div class="setting-info">
                        <h4>Auto-save calculations</h4>
                        <p>Automatically save your calculator settings</p>
                    </div>
                    <label class="setting-toggle">
                        <input type="checkbox" id="autoSaveToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-row">
                    <div class="setting-info">
                        <h4>Show calculation history</h4>
                        <p>Display recent calculations in calculators</p>
                    </div>
                    <label class="setting-toggle">
                        <input type="checkbox" id="historyToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Statistics View (Hidden by default) -->
        <div class="stats-view" id="statsView" style="display: none;">
            <div class="stats-header">
                <h3>Statistics</h3>
                <button class="close-btn" onclick="closeStatsView()">√ó</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="calculationsCount">0</div>
                    <div class="stat-label">Calculations Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="loginCount">1</div>
                    <div class="stat-label">Total Logins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lastLoginDate">Today</div>
                    <div class="stat-label">Last Login</div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div class="profile-message" id="profileMessage"></div>
    </div>
</div>

<!-- –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û: –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–∫—Ä–∏–ø—Ç–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É –ü–ï–†–ï–î CSS -->

<!-- 1. –°–ø–æ—á–∞—Ç–∫—É Profile Opening Logic -->
<script>
// –ù–ï–ì–ê–ô–ù–ï –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Profile Opening Logic - INLINE –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
const ProfileOpen = {
    openProfile() {
        console.log('üë§ Opening profile page...');
        
        const hasAuthUser = window.authManager && window.authManager.currentUser;
        const hasLocalUser = localStorage.getItem('armHelper_currentUser');
        const hasPersistentAuth = localStorage.getItem('armHelper_persistentAuth') === 'true';
        
        if (!hasAuthUser && (!hasLocalUser || !hasPersistentAuth)) {
            console.log('‚ö†Ô∏è No authentication found, redirecting to login...');
            if (typeof ProfileSystem !== 'undefined' && ProfileSystem.showMessage) {
                ProfileSystem.showMessage('Please login to view your profile', 'error');
            }
            if (typeof switchPage === 'function') {
                switchPage('login');
            }
            return;
        }

        if (typeof switchPage === 'function') {
            switchPage('profile');
            
            setTimeout(() => {
                if (typeof ProfileSystem !== 'undefined') {
                    ProfileSystem.loadCurrentUserData();
                    ProfileSystem.updateProfileDisplay();
                }
            }, 100);
        }
    },

    goBackFromProfile() {
        console.log('üîô Going back from profile...');
        if (typeof switchPage === 'function') {
            switchPage('calculator');
        }
    },

    updateLoginStats() {
        console.log('üìä Updating login stats...');
        
        const currentCount = parseInt(localStorage.getItem('armHelper_loginCount') || '0');
        const newCount = currentCount + 1;
        localStorage.setItem('armHelper_loginCount', newCount.toString());
        
        const now = new Date().toISOString();
        localStorage.setItem('armHelper_lastLogin', now);
        
        console.log('‚úÖ Login stats updated:', { 
            count: newCount, 
            lastLogin: now 
        });
    },

    isAuthenticated() {
        const hasAuthUser = window.authManager && window.authManager.currentUser;
        const hasLocalUser = localStorage.getItem('armHelper_currentUser');
        const hasPersistentAuth = localStorage.getItem('armHelper_persistentAuth') === 'true';
        
        return hasAuthUser || (hasLocalUser && hasPersistentAuth);
    },

    getCurrentUser() {
        if (window.authManager && window.authManager.currentUser && window.authManager.userProfile) {
            return {
                user: window.authManager.currentUser,
                profile: window.authManager.userProfile
            };
        }

        const savedUser = localStorage.getItem('armHelper_currentUser');
        const persistentAuth = localStorage.getItem('armHelper_persistentAuth');
        
        if (savedUser && persistentAuth === 'true') {
            try {
                const user = JSON.parse(savedUser);
                const userObj = {
                    id: user.id || 'local-user',
                    email: user.email || `${user.nickname}@local.test`,
                    nickname: user.nickname
                };
                
                return {
                    user: userObj,
                    profile: user
                };
            } catch (e) {
                console.warn('‚ö†Ô∏è Error parsing saved user data:', e);
                localStorage.removeItem('armHelper_currentUser');
                localStorage.removeItem('armHelper_persistentAuth');
            }
        }

        return null;
    },

    refreshProfileDisplay() {
        console.log('üîÑ Refreshing profile display...');
        if (typeof ProfileSystem !== 'undefined') {
            ProfileSystem.loadCurrentUserData();
            ProfileSystem.updateProfileDisplay();
        }
    }
};

// –ù–ï–ì–ê–ô–ù–û –µ–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
function openProfile() {
    console.log('üîÑ Global openProfile called');
    ProfileOpen.openProfile();
}

function goBackFromProfile() {
    console.log('üîÑ Global goBackFromProfile called');
    ProfileOpen.goBackFromProfile();
}

function updateLoginStats() {
    console.log('üîÑ Global updateLoginStats called');
    ProfileOpen.updateLoginStats();
}

function initializeProfileOpen() {
    console.log('üîÑ Global initializeProfileOpen called');
    return true; // –í–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ inline
}

function refreshProfileDisplay() {
    console.log('üîÑ Global refreshProfileDisplay called');
    ProfileOpen.refreshProfileDisplay();
}

// –ù–ï–ì–ê–ô–ù–û –µ–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –≤ window
window.ProfileOpen = ProfileOpen;
window.openProfile = openProfile;
window.goBackFromProfile = goBackFromProfile;
window.updateLoginStats = updateLoginStats;
window.initializeProfileOpen = initializeProfileOpen;
window.refreshProfileDisplay = refreshProfileDisplay;

console.log('‚úÖ Profile opening functions loaded INLINE and exported to window');
</script>

<!-- 2. –ü–æ—Ç—ñ–º Profile CSS -->
<link rel="stylesheet" href="login/profile.css">

<!-- 3. –ü–æ—Ç—ñ–º Profile JavaScript Files -->
<script src="login/profile.js"></script>
<script src="login/profile-settings.js"></script>

<style>
/* Enhanced profile styles for better nickname display */
.profile-info {
    text-align: center;
    margin-top: 15px;
}

.profile-nickname {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
}

.profile-avatar {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
}

.avatar-img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease;
}

.avatar-img:hover {
    transform: scale(1.05);
}

/* Loading state for nickname */
.profile-nickname.loading {
    opacity: 0.6;
    color: #cccccc;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .profile-nickname {
        font-size: 24px;
    }
    
    .avatar-img {
        width: 80px;
        height: 80px;
    }
}
</style>

<!-- Profile Initialization Script -->
<script>
// Ensure all profile components are initialized
document.addEventListener('DOMContentLoaded', function() {
    console.log('üë§ Initializing all profile components...');
    
    // Small delay to ensure all scripts are loaded
    setTimeout(() => {
        // Initialize main profile system
        if (typeof initializeProfile === 'function') {
            initializeProfile();
        }
        
        console.log('‚úÖ All profile components initialized');
    }, 150);
});

// Listen for page changes to ensure profile is properly loaded
document.addEventListener('pageChanged', function(event) {
    if (event.detail?.page === 'profile') {
        console.log('üë§ Profile page opened, ensuring components are ready...');
        
        setTimeout(() => {
            if (typeof refreshProfileDisplay === 'function') {
                refreshProfileDisplay();
            }
        }, 100);
    }
});
</script>
